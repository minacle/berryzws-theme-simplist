/* ---------------------------------------------------------------------- *
 *                                                                        *
 *                                                                        *
 *                  + Berryz WebShare "SIMPLIST" theme +                  *
 *          Copyright (c) 2015, 2018  Mayu Laierlence (Minacle).          *
 *                                                                        *
 *                                                                        *
 * ---------------------------------------------------------------------- *
 *                                                                        *
 *                                                                        *
 *                        The Artistic License 2.0                        *
 *                                                                        *
 *             Copyright (c) 2000-2006, The Perl Foundation.              *
 *                                                                        *
 *      Everyone is permitted to copy and distribute verbatim copies      *
 *       of this license document, but changing it is not allowed.        *
 *                                                                        *
 * Preamble                                                               *
 *                                                                        *
 * This license establishes the terms under which a given free software   *
 * Package may be copied, modified, distributed, and/or redistributed.    *
 * The intent is that the Copyright Holder maintains some artistic        *
 * control over the development of that Package while still keeping the   *
 * Package available as open source and free software.                    *
 *                                                                        *
 * You are always permitted to make arrangements wholly outside of this   *
 * license directly with the Copyright Holder of a given Package.  If the *
 * terms of this license do not permit the full use that you propose to   *
 * make of the Package, you should contact the Copyright Holder and seek  *
 * a different licensing arrangement.                                     *
 *                                                                        *
 * Definitions                                                            *
 *                                                                        *
 *     "Copyright Holder" means the individual(s) or organization(s)      *
 *     named in the copyright notice for the entire Package.              *
 *                                                                        *
 *     "Contributor" means any party that has contributed code or other   *
 *     material to the Package, in accordance with the Copyright Holder's *
 *     procedures.                                                        *
 *                                                                        *
 *     "You" and "your" means any person who would like to copy,          *
 *     distribute, or modify the Package.                                 *
 *                                                                        *
 *     "Package" means the collection of files distributed by the         *
 *     Copyright Holder, and derivatives of that collection and/or of     *
 *     those files. A given Package may consist of either the Standard    *
 *     Version, or a Modified Version.                                    *
 *                                                                        *
 *     "Distribute" means providing a copy of the Package or making it    *
 *     accessible to anyone else, or in the case of a company or          *
 *     organization, to others outside of your company or organization.   *
 *                                                                        *
 *     "Distributor Fee" means any fee that you charge for Distributing   *
 *     this Package or providing support for this Package to another      *
 *     party.  It does not mean licensing fees.                           *
 *                                                                        *
 *     "Standard Version" refers to the Package if it has not been        *
 *     modified, or has been modified only in ways explicitly requested   *
 *     by the Copyright Holder.                                           *
 *                                                                        *
 *     "Modified Version" means the Package, if it has been changed, and  *
 *     such changes were not explicitly requested by the Copyright        *
 *     Holder.                                                            *
 *                                                                        *
 *     "Original License" means this Artistic License as Distributed with *
 *     the Standard Version of the Package, in its current version or as  *
 *     it may be modified by The Perl Foundation in the future.           *
 *                                                                        *
 *     "Source" form means the source code, documentation source, and     *
 *     configuration files for the Package.                               *
 *                                                                        *
 *     "Compiled" form means the compiled bytecode, object code, binary,  *
 *     or any other form resulting from mechanical transformation or      *
 *     translation of the Source form.                                    *
 *                                                                        *
 *                                                                        *
 * Permission for Use and Modification Without Distribution               *
 *                                                                        *
 * (1)  You are permitted to use the Standard Version and create and use  *
 * Modified Versions for any purpose without restriction, provided that   *
 * you do not Distribute the Modified Version.                            *
 *                                                                        *
 *                                                                        *
 * Permissions for Redistribution of the Standard Version                 *
 *                                                                        *
 * (2)  You may Distribute verbatim copies of the Source form of the      *
 * Standard Version of this Package in any medium without restriction,    *
 * either gratis or for a Distributor Fee, provided that you duplicate    *
 * all of the original copyright notices and associated disclaimers.  At  *
 * your discretion, such verbatim copies may or may not include a         *
 * Compiled form of the Package.                                          *
 *                                                                        *
 * (3)  You may apply any bug fixes, portability changes, and other       *
 * modifications made available from the Copyright Holder.  The resulting *
 * Package will still be considered the Standard Version, and as such     *
 * will be subject to the Original License.                               *
 *                                                                        *
 *                                                                        *
 * Distribution of Modified Versions of the Package as Source             *
 *                                                                        *
 * (4)  You may Distribute your Modified Version as Source (either gratis *
 * or for a Distributor Fee, and with or without a Compiled form of the   *
 * Modified Version) provided that you clearly document how it differs    *
 * from the Standard Version, including, but not limited to, documenting  *
 * any non-standard features, executables, or modules, and provided that  *
 * you do at least ONE of the following:                                  *
 *                                                                        *
 *     (a)  make the Modified Version available to the Copyright Holder   *
 *     of the Standard Version, under the Original License, so that the   *
 *     Copyright Holder may include your modifications in the Standard    *
 *     Version.                                                           *
 *                                                                        *
 *     (b)  ensure that installation of your Modified Version does not    *
 *     prevent the user installing or running the Standard Version. In    *
 *     addition, the Modified Version must bear a name that is different  *
 *     from the name of the Standard Version.                             *
 *                                                                        *
 *     (c)  allow anyone who receives a copy of the Modified Version to   *
 *     make the Source form of the Modified Version available to others   *
 *     under                                                              *
 *                                                                        *
 *         (i)  the Original License or                                   *
 *                                                                        *
 *         (ii)  a license that permits the licensee to freely copy,      *
 *         modify and redistribute the Modified Version using the same    *
 *         licensing terms that apply to the copy that the licensee       *
 *         received, and requires that the Source form of the Modified    *
 *         Version, and of any works derived from it, be made freely      *
 *         available in that license fees are prohibited but Distributor  *
 *         Fees are allowed.                                              *
 *                                                                        *
 *                                                                        *
 * Distribution of Compiled Forms of the Standard Version                 *
 * or Modified Versions without the Source                                *
 *                                                                        *
 * (5)  You may Distribute Compiled forms of the Standard Version without *
 * the Source, provided that you include complete instructions on how to  *
 * get the Source of the Standard Version.  Such instructions must be     *
 * valid at the time of your distribution.  If these instructions, at any *
 * time while you are carrying out such distribution, become invalid, you *
 * must provide new instructions on demand or cease further distribution. *
 * If you provide valid instructions or cease distribution within thirty  *
 * days after you become aware that the instructions are invalid, then    *
 * you do not forfeit any of your rights under this license.              *
 *                                                                        *
 * (6)  You may Distribute a Modified Version in Compiled form without    *
 * the Source, provided that you comply with Section 4 with respect to    *
 * the Source of the Modified Version.                                    *
 *                                                                        *
 *                                                                        *
 * Aggregating or Linking the Package                                     *
 *                                                                        *
 * (7)  You may aggregate the Package (either the Standard Version or     *
 * Modified Version) with other packages and Distribute the resulting     *
 * aggregation provided that you do not charge a licensing fee for the    *
 * Package.  Distributor Fees are permitted, and licensing fees for other *
 * components in the aggregation are permitted. The terms of this license *
 * apply to the use and Distribution of the Standard or Modified Versions *
 * as included in the aggregation.                                        *
 *                                                                        *
 * (8) You are permitted to link Modified and Standard Versions with      *
 * other works, to embed the Package in a larger work of your own, or to  *
 * build stand-alone binary or bytecode versions of applications that     *
 * include the Package, and Distribute the result without restriction,    *
 * provided the result does not expose a direct interface to the Package. *
 *                                                                        *
 *                                                                        *
 * Items That are Not Considered Part of a Modified Version               *
 *                                                                        *
 * (9) Works (including, but not limited to, modules and scripts) that    *
 * merely extend or make use of the Package, do not, by themselves, cause *
 * the Package to be a Modified Version.  In addition, such works are not *
 * considered parts of the Package itself, and are not subject to the     *
 * terms of this license.                                                 *
 *                                                                        *
 *                                                                        *
 * General Provisions                                                     *
 *                                                                        *
 * (10)  Any use, modification, and distribution of the Standard or       *
 * Modified Versions is governed by this Artistic License. By using,      *
 * modifying or distributing the Package, you accept this license. Do not *
 * use, modify, or distribute the Package, if you do not accept this      *
 * license.                                                               *
 *                                                                        *
 * (11)  If your Modified Version has been derived from a Modified        *
 * Version made by someone other than you, you are nevertheless required  *
 * to ensure that your Modified Version complies with the requirements of *
 * this license.                                                          *
 *                                                                        *
 * (12)  This license does not grant you the right to use any trademark,  *
 * service mark, tradename, or logo of the Copyright Holder.              *
 *                                                                        *
 * (13)  This license includes the non-exclusive, worldwide,              *
 * free-of-charge patent license to make, have made, use, offer to sell,  *
 * sell, import and otherwise transfer the Package with respect to any    *
 * patent claims licensable by the Copyright Holder that are necessarily  *
 * infringed by the Package. If you institute patent litigation           *
 * (including a cross-claim or counterclaim) against any party alleging   *
 * that the Package constitutes direct or contributory patent             *
 * infringement, then this Artistic License to you shall terminate on the *
 * date that such litigation is filed.                                    *
 *                                                                        *
 * (14)  Disclaimer of Warranty:                                          *
 * THE PACKAGE IS PROVIDED BY THE COPYRIGHT HOLDER AND CONTRIBUTORS "AS   *
 * IS' AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES. THE IMPLIED         *
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR    *
 * NON-INFRINGEMENT ARE DISCLAIMED TO THE EXTENT PERMITTED BY YOUR LOCAL  *
 * LAW. UNLESS REQUIRED BY LAW, NO COPYRIGHT HOLDER OR CONTRIBUTOR WILL   *
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL       *
 * DAMAGES ARISING IN ANY WAY OUT OF THE USE OF THE PACKAGE, EVEN IF      *
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                             *
 *                                                                        *
 *                                                                        *
 * ---------------------------------------------------------------------- *
 *                                                                        *
 *                                                                        *
 *                                               ORIGINAL COPYRIGHT TEXT. *
 *                                                                        *
 *         Berryz WebShare "SIMPLIST" theme by Mayu Laierlence (Minacle). *
 *         only for Project MS (PJMS). Happy birthday <3     2015. 1. 17. *
 *                                      SIMPLIST/script.js ~ 2015. 1. 28. *
 *                                                                        *
 *                                                                        *
 * ---------------------------------------------------------------------- */

function onUpdateUpload(text) {
    var popup = document.getElementsByName('upload-popup')[0];
    var container = popup.getElementsByClassName('upload-progress')[0];
    if (text.lastIndexOf('<br/>') >= 0) {
        text = text.match(/<br\/>(.*)<a/)[1];
        popup.querySelector('button[type=cancel]').style.display = 'none';
        popup.querySelector('button[type=submit]').style.display = 'inline-block !important';
    }
    container.getElementsByTagName('span')[0].textContent = text;

}

function onUpdateProgress(perc) {
    document.getElementsByName('upload-progress-value')[0].style.width = perc + '%';
}

(function() {

    function getClasses(e) {
        var cs = e.className.split(' ');
        var r = [];
        for (var i = 0; i < cs.length; i++)
            cs[i] && r.push(cs[i]);
        return r;
    }

    function setClasses(e, cs) {
        e.className = cs.join(' ');
    }

    function hasClass(e, c) {
        return getClasses(e).indexOf(c) >= 0;
    }

    function addClass(e, c) {
        var cs = getClasses(e);
        cs.indexOf(c) < 0 && cs.push(c);
        setClasses(e, cs);
    }

    function removeClass(e, c) {
        var cs = getClasses(e);
        var i = cs.indexOf(c);
        i < 0 || cs.splice(i, 1);
        setClasses(e, cs);
    }

    var dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    var monthName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function getCookies() {
        var p = /\s*([\w-%]+)\s*=\s*([^;]*)\s*;?/g;
        var i;
        var r = {};
        while ((i = p.exec(document.cookie)) !== null)
            r[i[1]] = i[2];
        return r;
    }

    function getCookie(k) {
        var cs = getCookies();
        for (c in cs)
            if (c === k)
                return cs[c];
        return undefined;
    }

    function setCookie(k, v, x, p) {
        if (x === undefined)
            x = 0;
        if (p === undefined)
            p = location.pathname;
        var d = new Date();
        d.setDate(d.getDate() + x);
        x = dayName[d.getUTCDay()] + ', ' + d.getUTCDate() + ' ' + monthName[d.getUTCMonth()] + ' ' + d.getUTCFullYear() + ' ' + d.getUTCHours() + ':' + d.getUTCMinutes() + ':' + d.getUTCSeconds() + ' UTC';
        document.cookie = encodeURIComponent(k) + '=' + encodeURIComponent(v) + '; expires=' + x + '; path=' + p;
    }

    function hasCookie(k) {
        var cs = getCookies();
        for (c in cs)
            if (c === k)
                return true;
        return false;
    }

    function findParentByClassName(e, q) {
        var p = e.parentNode;
        if (!p)
            return p;
        else if (hasClass(p, q))
            return p;
        return findParentByClassName(p, q);
    }

    function makeElementByHTML(t) {
        var c = document.createElement('div');
        c.innerHTML = t;
        var r = c.children[0];
        c.removeChild(r);
        delete c;
        return r;
    }

    var allToggle = document.getElementsByName('select-all')[0];
    var switches = document.body.querySelectorAll('#list button');

    function switchSet(s, v) {
        var r = s.getAttribute('value');
        if (s.getAttribute('name') == 'select-all') {
            if (v == 'toggle') {
                s.setAttribute('value', 'toggle');
                addClass(s.querySelector('.fa-circle-o'), 'collapsed');
                addClass(s.querySelector('.fa-check-circle'), 'collapsed');
                removeClass(s.querySelector('.fa-check-circle-o'), 'collapsed');
            }
            else if (v) {
                removeClass(s.querySelector('.fa-circle-o'), 'collapsed');
                addClass(s.querySelector('.fa-check-circle'), 'collapsed');
                addClass(s.querySelector('.fa-check-circle-o'), 'collapsed');
                s.setAttribute('value', 'off');
            }
            else {
                addClass(s.querySelector('.fa-circle-o'), 'collapsed');
                removeClass(s.querySelector('.fa-check-circle'), 'collapsed');
                addClass(s.querySelector('.fa-check-circle-o'), 'collapsed');
                s.setAttribute('value', 'on');
            }
        }
        else if (v == 'toggle') {
            if (s.getAttribute('value'))
                return switchSet(s, false);
            else
                return switchSet(s, true);
        }
        else if (v) {
            addClass(s.querySelector('.fa-circle-o'), 'collapsed');
            removeClass(s.querySelector('.fa-check-circle'), 'collapsed');
            s.setAttribute('value', 'on');
        }
        else {
            removeClass(s.querySelector('.fa-circle-o'), 'collapsed');
            addClass(s.querySelector('.fa-check-circle'), 'collapsed');
            s.removeAttribute('value');
        }
        return r;
    }

    allToggle.addEventListener('click', function(event) {
        var v = this.getAttribute('value') || 'on';
        switch (v) {
            case 'on':
                switchSet(this, true);
                for (var i = 0; i < switches.length; i++)
                    switchSet(switches[i], true);
                break;
            case 'off':
                switchSet(this, false);
                for (var i = 0; i < switches.length; i++)
                    switchSet(switches[i], false);
                break;
            case 'toggle':
                var on = 0;
                var off = 0;
                for (var i = 0; i < switches.length; i++) {
                    if (switchSet(switches[i], 'toggle'))
                        on++;
                    else
                        off++;
                }
                if (on < off)
                    switchSet(allToggle, true);
                else
                    switchSet(allToggle, false);
        }
    }, false);

    for (var i = 0; i < switches.length; i++)
        switches[i].addEventListener('click', function(event) {
            event.preventDefault();
            switchSet(allToggle, 'toggle');
            switchSet(this, 'toggle');
        }, false);

    var nav = document.getElementsByClassName('nav')[0];
    var path = nav.getElementsByClassName('path')[0];
    var pathSpan = nav.getElementsByClassName('path-tree')[0];

    function buildUpperPath(c, t) {
        var r = [];
        for (var i = c; c > t; c--) {
            r.push('..');
        }
        return r.join('/');
    }

    var _berryz = typeof berryz !== 'undefined';

    if (_berryz && berryz.hasOwnProperty('address')) {
        var t = berryz.address.split('/');
        for (var i = 1; i < t.length - 1; i++) {
            var a = document.createElement('a');
            a.textContent = t[i];
            a.setAttribute('href', buildUpperPath(t.length - 2, i));
            pathSpan.appendChild(a);
        }
    }

    var pathContainer = nav.getElementsByClassName('path-container')[0];
    var pathLeft;

    function calculatePathLeft() {
        var offsetLeft = path.offsetLeft;
        var t = path;
        while ((t = t.parentNode))
            offsetLeft += t.offsetLeft || 0;
        pathLeft = offsetLeft;
    }

    calculatePathLeft();
    window.addEventListener('resize', calculatePathLeft, false);

    var seekPathLeft = 0.0;
    var seekPathAnimation;

    function seekPathAbsolute(v) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        var d = path.children[0].scrollWidth - path.offsetWidth;
        if (d < 0)
            d = 0;
        seekPathLeft = d * -v;
        path.children[0].style.left = Math.round(seekPathLeft) + 'px';
    }

    function seekPathRelative(v) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        seekPathLeft += v;
        if (seekPathLeft > 0)
            seekPathLeft = 0.0;
        else if (seekPathLeft < -(path.children[0].scrollWidth - path.offsetWidth))
            seekPathLeft = -(path.children[0].scrollWidth - path.offsetWidth);
        path.children[0].style.left = Math.round(seekPathLeft) + 'px';
    }

    function seekPathRelativeAnimation(v, f) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        if (seekPathAnimation !== undefined)
            clearInterval(seekPathAnimation);
        var x = v;
        seekPathAnimation = setInterval(function() {
            seekPathLeft += x;
            if (seekPathLeft > 0)
                seekPathLeft = 0.0;
            else if (seekPathLeft < -(path.children[0].scrollWidth - path.offsetWidth))
                seekPathLeft = -(path.children[0].scrollWidth - path.offsetWidth);
            path.children[0].style.left = Math.round(seekPathLeft) + 'px';
            x -= x * f;
            if (Math.abs(x) < 0.5) {
                clearInterval(seekPathAnimation);
                seekPathAnimation = undefined;
            }
        }, 50 / 3);
    }

    var touchOldX;
    var touchOldY;
    var touchX;
    var touchY;
    var touchId = -1;
    var touchMoveSense = 16;
    var touchMoveSenseFlag = true;

    path.addEventListener('touchstart', function(event) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        addClass(this, 'touchdevice');
        if (seekPathAnimation !== undefined)
            clearInterval(seekPathAnimation);
        if (touchId < 0) {
            var t = event.changedTouches[0];
            touchId = t.identifier;
            touchX = t.pageX;
            touchY = t.pageY;
            touchOldX = undefined;
            touchOldY = undefined;
        }
    }, false);

    path.addEventListener('touchmove', function(event) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        if (seekPathAnimation !== undefined)
            clearInterval(seekPathAnimation);
        var t;
        for (var i = 0; i < event.touches.length; i++)
            if (event.touches[i].identifier === touchId) {
                t = event.touches[i];
                break;
            }
        if (!t)
            return;
        if (touchMoveSenseFlag && Math.abs(t.pageY - touchY) - touchMoveSense > 0) {
            touchId = -1;
            return;
        }
        var v = t.pageX - touchX;
        if (touchMoveSenseFlag && Math.abs(v) - touchMoveSense <= 0)
            return;
        event.preventDefault();
        touchMoveSenseFlag = false;
        seekPathRelative(v);
        touchOldX = touchX;
        touchOldY = touchY;
        touchX = t.pageX;
        touchY = t.pageY;
    }, false);

    path.addEventListener('touchend', function(event) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        var prevent = false;
        if (seekPathAnimation !== undefined)
            clearInterval(seekPathAnimation);
        for (var i = 0; i < event.changedTouches.length; i++)
            if (event.changedTouches[i].identifier == touchId) {
                var t = event.changedTouches[i];
                touchId = -1;
                touchMoveSenseFlag = true;
                if (touchOldX !== undefined) {
                    seekPathRelativeAnimation(touchX - touchOldX, 1 / 11);
                    prevent = true;
                }
                event.preventDefault();
                if (!prevent) {
                    event.target.focus();
                    event.target.click();
                }
                break;
            }
    }, false);

    path.addEventListener('touchcancel', function(event) {
        if (path.children[0].scrollWidth < path.offsetWidth)
            return;
        for (var i = 0; i < event.changedTouches.length; i++)
            if (event.changedTouches[i].identifier == touchId) {
                var t = event.changedTouches[i];
                touchId = -1;
                touchMoveSenseFlag = true;
                break;
            }
    }, false);

    path.addEventListener('mousemove', function(event) {
        var v = (event.pageX - pathLeft) / this.offsetWidth;
        seekPathAbsolute(v);
    }, false);

    path.addEventListener('mouseleave', function(event) {
        seekPathAbsolute(1);
    }, false);

    window.addEventListener('load', function(event) {
        seekPathAbsolute(1);
    }, false);

    var dropdowns = nav.getElementsByClassName('dropdown');
    var dropdownHandles = nav.querySelectorAll('.dropdown .dropdown-handle');

    for (var i = 0; i < dropdownHandles.length; i++) {
        dropdownHandles[i].addEventListener('click', function(event) {
            for (var i = 0; i < dropdowns.length; i++) {
                if (dropdowns[i] == this.parentNode)
                    if (hasClass(dropdowns[i], 'dropdown-opened'))
                        removeClass(dropdowns[i], 'dropdown-opened');
                    else
                        addClass(dropdowns[i], 'dropdown-opened');
                else
                    removeClass(dropdowns[i], 'dropdown-opened');
            }
        }, false);
        //firefox
        dropdownHandles[i].parentNode.addEventListener('blur', function(event) {
            var owner = this;
            setTimeout(function() {
                var opened = hasClass(owner, 'dropdown-opened');
                removeClass(owner, 'dropdown-opened');
            }, 200);
        }, false);
        //others
        dropdownHandles[i].parentNode.addEventListener('focusout', function(event) {
            var opened = hasClass(this, 'dropdown-opened');
            removeClass(this, 'dropdown-opened');
        }, false);
    }

    var listHeader = document.body.querySelectorAll('.list.header>*>*>* button');
    var list = document.getElementById('list');

    var fileTypes = {
        archive: [
            'iso', 'tar', 'bz2', 'gz', 'lz', 'lzma', 'xz', 'z', '7z', 's7z',
            'alz', 'apk', 'cab', 'dmg', 'lzh', 'lha', 'lzh', 'pak', 'rar', 'sfx',
            'tgz', 'tbz2', 'tlz', 'wim', 'zip'
        ],
        audio: [
            'wav', 'aiff', 'pcm', 'flac', 'ape', 'wv', 'tta', 'm4a', 'wma', 'mp3',
            'ogg', 'aac', 'tta', 'mid'
        ],
        code: [
            'asm', 'bas', 'c', 'cpp', 'cc', 'cxx', 'cs', 'h', 'hpp', 'hxx',
            'java', 'lisp', 'm', 'php', 'pl', 'py', 'rb', 'vb', 'as', 'bat',
            'cmd', 'coffee', 'js', 'lua', 'sh', 'vbs', 'html', 'css'
        ],
        image: [
            'bmp', 'dds', 'gif', 'icns', 'ico', 'jpg', 'jpeg', 'png', 'psd', 'tga',
            'tif', 'tiff', 'xcf'
        ],
        text: [
            'txt', 'ini', 'json', 'xml', 'yaml', 'sami', 'smi', 'ass', 'ssa', 'srt'
        ],
        video: [
            'aaf', '3gp', 'avi', 'flv', 'fla', 'm4v', 'mkv', 'mov', 'mpeg',
            'mpg', 'mpe', 'mp4', 'swf', 'wmv'
        ]
    };

    function getIcon(icon, name) {
        if (name.indexOf('.') <= 0)
            return;
        var x = name.split('.').splice(-1)[0];
        var f = false;
        for (t in fileTypes) {
            for (var i = 0; i < fileTypes[t].length; i++)
            if (fileTypes[t][i] == x) {
                removeClass(icon, 'fa-file-o');
                addClass(icon, 'fa-file-' + t + '-o');
                f = true;
                break;
            }
            if (f)
            break;
        }
    }

    (function() {
        var rowgroup = list.children;
        for (var i = 0; i < rowgroup.length; i++) {
            var rows = rowgroup[i].children;
            for (var i = 0; i < rows.length; i++) {
                var icon = rows[i].querySelector('[name=row-icon-cell] i.fa-file-o');
                console.log(icon);
                if (icon)
                    getIcon(icon, rows[i].querySelector('[name=row-name-cell]').textContent);
            }
        }
    })();

    var hiraganaOrderTable = [];
    var katakanaOrderTable = [];

    for (var i = 0x3041; i <= 0x3096; i++)
        hiraganaOrderTable.push(String.fromCharCode(i));

    for (var i = 0x30a1; i <= 0x30f6; i++)
        katakanaOrderTable.push(String.fromCharCode(i));

    function fullwidthToHalfwidth(s) {
        var r = '';
        for (var i = 0; i < s.length; i++) {
            if (s[i] >= '\uff00' && s[i] <= '\uff5e')
                r += String.fromCharCode(s.charCodeAt(i) - 0xfee0);
            else
                r += s[i];
        }
        return r;
    }

    function katakanaToHiragana(s) {
        var r = '';
        for (var i = 0; i < s.length; i++) {
            if (s[i] >= '\u30a1' && s[i] <= '\u30f6')
                r += String.fromCharCode(s.charCodeAt(i) - 0x60);
            else
                r += s[i];
        }
        return r;
    }

    function hiraganaToKatakana(s) {
        var r = '';
        for (var i = 0; i < s.length; i++) {
            if (s[i] >= '\u3041' && s[i] <= '\u3096')
                r += String.fromCharCode(s.charCodeAt(i) + 0x60);
            else
                r += s[i];
        }
        return r;
    }

    function sortRule(o, x, y) {
        function isNumber(v) {
            return typeof x === 'number';
        }
        if (isNumber(x) && isNumber(y) && isNaN(x) && isNaN(y))
            return NaN;
        else if (isNumber(x) && isNaN(x))
            return 1 * o;
        else if (isNumber(y) && isNaN(y))
            return -1 * o;
        else if (x > y)
            return 1;
        else if (x < y)
            return -1;
        return 0;
    }

    function unsortRule(o, a, b, x, y) {
        if (a > b)
            return 1;
        else if (a < b)
            return -1;
        else if (x > y)
            return 1 * o;
        else if (x < y)
            return -1 * o;
        return 0;
    }

    function sortList(column, order) {
        var rowgroup = list.children;
        for (var i = 0; i < rowgroup.length; i++) {
            var rows = rowgroup[i].children;
            for (var i = 0; i < rows.length - 1; i++) {
                if (i < 0)
                    continue;
                if (rows[i].getAttribute('sort') == 'no')
                    continue;
                var currentValue = rows[i].children[column].textContent || '';
                var nextValue = rows[i + 1].children[column].textContent || '';
                if (column == 2) {
                    currentValue = katakanaToHiragana(fullwidthToHalfwidth(currentValue).toLowerCase());
                    nextValue = katakanaToHiragana(fullwidthToHalfwidth(nextValue).toLowerCase());
                }
                else if (column == 3) {
                    currentValue = parseInt(currentValue.replace(/,/g, ''));
                    nextValue = parseInt(nextValue.replace(/,/g, ''));
                }
                var result = sortRule(order, currentValue, nextValue);
                if (isNaN(result)) {
                    var currentIndex = parseInt(rows[i].getAttribute('index'));
                    var nextIndex = parseInt(rows[i + 1].getAttribute('index'));
                    var currentType = rows[i].getAttribute('type');
                    var nextType = rows[i + 1].getAttribute('type');
                    result = unsortRule(order, currentType, nextType, currentIndex, nextIndex);
                }
                if (order > 0 && result > 0 || order < 0 && result < 0) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    i -= 2;
                }
            }
        }
    }

    function unsortList(order) {
        var rowgroup = list.children;
        for (var i = 0; i < rowgroup.length; i++) {
            var rows = rowgroup[i].children;
            for (var i = 0; i < rows.length - 1; i++) {
                if (i < 0)
                    continue;
                if (rows[i].getAttribute('sort') == 'no')
                    continue;
                var currentIndex = parseInt(rows[i].getAttribute('index'));
                var nextIndex = parseInt(rows[i + 1].getAttribute('index'));
                var currentType = rows[i].getAttribute('type');
                var nextType = rows[i + 1].getAttribute('type');
                var result = unsortRule(order, currentType, nextType, currentIndex, nextIndex);
                if (order > 0 && result > 0 || order < 0 && result < 0) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    i -= 2;
                }
            }
        }
    }

    (function() {
        var rowgroup = list.children;
        for (var i = 0; i < rowgroup.length; i++) {
            var rows = rowgroup[i].children;
            var dn = 0;
            var fn = 0;
            var ps = 0;
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].getAttribute('sort') == 'no') {
                    ps += 1;
                    continue;
                }
                rows[i].setAttribute('name', 'item-' + (i - ps));
                if (hasClass(rows[i].children[1].children[0], 'fa-folder-o')) {
                    rows[i].setAttribute('type', 'dir');
                    rows[i].setAttribute('index', dn);
                    dn += 1;
                }
                else {
                    rows[i].setAttribute('type', 'file');
                    rows[i].setAttribute('index', fn);
                    fn += 1;
                }
                //getIcon(rows[i].getElementsByClassName('fa-file-o')[0], rows[i].getElementsByName('row-name-cell')[0]);
            }
        }
    })();

    var userSort = hasCookie('user-sort') && getCookie('user-sort') || undefined;
    var userSortOrder = hasCookie('user-sort-order') && getCookie('user-sort-order') || 0;

    for (var i = 1; i < listHeader.length; i++) {
        listHeader[i].addEventListener('click', function(event) {
            var fa = this.getElementsByClassName('fa');
            var v = parseInt(this.getAttribute('value'));
            var c = parseInt(this.getAttribute('column'));
            if (c == 1)
                unsortList(v);
            else
                sortList(c, v);
            v *= -1;
            if (v > 0) {
                removeClass(fa[0], 'collapsed');
                addClass(fa[1], 'collapsed');
            }
            else if (v < 0) {
                addClass(fa[0], 'collapsed');
                removeClass(fa[1], 'collapsed');
            }
            else {
                addClass(fa[0], 'collapsed');
                addClass(fa[1], 'collapsed');
            }
            this.setAttribute('value', v);
            for (var i = 1; i < listHeader.length; i++) {
                if (i == c)
                    continue;
                fa = listHeader[i].getElementsByClassName('fa');
                removeClass(fa[0], 'collapsed');
                addClass(fa[1], 'collapsed');
                listHeader[i].setAttribute('value', 1);
            }
            setCookie('user-sort', this.getAttribute('name'), 30);
            setCookie('user-sort-order', -v, 30);
        }, false);
        var headerName = listHeader[i].getAttribute('name');
        if (userSort === headerName && userSortOrder) {
            listHeader[i].setAttribute('value', parseInt(userSortOrder));
            setCookie('user-sort', userSort, 30);
            setCookie('user-sort-order', userSortOrder, 30);
            listHeader[i].click();
        }
    }

    if (_berryz && !berryz.hasOwnProperty('current_login_id')) {
        var userButton = document.getElementsByName('user-button')[0];
        userButton.click();
        userButton.parentNode.focus();
    }

    function post(path, params) {
        var form = document.createElement('form');
        form.setAttribute('method', 'POST');
        form.setAttribute('action', path);
        for (var key in params) {
            if (params.hasOwnProperty(key)) {
                var hiddenField = document.createElement('input');
                hiddenField.setAttribute('type', 'hidden');
                hiddenField.setAttribute('name', key);
                hiddenField.setAttribute('value', params[key]);
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }

    var plugins = document.getElementsByClassName('plugin-popup')[0].children;

    for (var i = 0; i < plugins.length; i++)
        plugins[i].addEventListener('click', function(event) {
            var items = [];
            var rowgroup = list.children;
            for (var i = 0; i < rowgroup.length; i++) {
                var rows = rowgroup[i].children;
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].children[0].getAttribute('name') == 'row-select-cell' && rows[i].children[0].getElementsByTagName('button')[0].getAttribute('value') == 'on')
                        items.push(rows[i].getAttribute('href'));
                }
            }
            if (items.length == 0)
                return;
            post('?action=Plugin&type=' + this.getAttribute('name'), {
                selectedFiles: items.join('\n') + '\n'
            });
        }, false);

    document.getElementsByName('upload-mkdir')[0].addEventListener('click', function(event) {
        removeClass(document.getElementsByName('mkdir-popup')[0], 'collapsed');
    }, false);

    var uploadPopup = document.getElementsByName('upload-popup')[0];
    var uploadContent = uploadPopup.getElementsByClassName('upload-content')[0];
    var uploadProgress = uploadPopup.getElementsByClassName('upload-progress')[0];
    var uploadInput;
    var uploadKey;

    document.getElementsByName('upload-files')[0].addEventListener('click', function(event) {
        var hidden = document.getElementsByName('upload-hidden')[0];
        hidden.innerHTML = '<iframe src="/' + berryz.skin + '/upload.html?action=SkinFile"></iframe>';
        addClass(uploadProgress, 'collapsed');
        removeClass(uploadContent, 'collapsed');
        uploadKey = '[' + Math.random() + ']';
        uploadInput = makeElementByHTML('<input name="uploadfile" type="file" />');
        while (uploadContent.children.length)
            uploadContent.removeChild(uploadContent.children[0]);
        uploadContent.appendChild(uploadInput);
        removeClass(uploadPopup, 'collapsed');
    }, false);

    document.body.querySelector('[name=upload-popup] button[type=submit]').addEventListener('click', function(event) {
        if (document.getElementsByName('upload-progress-value')[0].textContent.trim() != '') {
            location.reload();
            return false;
        }
        var hidden = document.getElementsByName('upload-hidden')[0];
        var hiddenForm = hidden.children[0].contentDocument.getElementsByTagName('form')[0];
        if (hiddenForm === undefined)
            return false;
        hiddenForm.setAttribute('action', location.pathname + '?action=Upload&key=' + uploadKey);
        uploadContent.removeChild(uploadInput);
        hiddenForm.appendChild(uploadInput);
        hiddenForm.submit();
        var footer = uploadPopup.getElementsByClassName('modal-footer')[0];
        removeClass(footer, 'modal-button-2');
        addClass(footer, 'modal-button-1');
        addClass(footer.querySelector('button[type=submit]'), 'collapse');
        var progress =  document.getElementsByName('upload-progress-hidden')[0];
        progress.innerHTML = '<iframe src="?action=UploadStatus&key=' + uploadKey + '"></iframe>';
        addClass(uploadContent, 'collapsed');
        removeClass(uploadProgress, 'collapsed');
        event.preventDefault();
    }, false);

    document.body.querySelector('[name=upload-popup] button[type=cancel]').addEventListener('click', function(event) {
        event.preventDefault();
        if (hasClass(uploadContent, 'collapsed'))
            location.reload();
    }, false);

    var cancelButtons = document.body.querySelectorAll('button[type=cancel]');

    for (var i = 0; i < cancelButtons.length; i++)
        cancelButtons[i].addEventListener('click', function(event) {
            addClass(findParentByClassName(this, 'modal-dim'), 'collapsed');
            event.preventDefault();
        }, false);

})();
